<% layout('layouts/main') %>

<% 
  // Nếu res.locals.user chưa được set (undefined), gán về object rỗng
  const perms = (typeof user !== 'undefined' && user && user.permissions) 
                ? user.permissions 
                : []; 
%>

<%- include('../partials/table', {
  title: title,
  action_new: `
    ${(perms.includes('users:create')) ? 
    `<div class="flex px-6 mb-6">
      <a href="/admin/users/new" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300 shadow-md">
        + Tạo User mới
      </a>
    </div>` : ``}
  `,
  headers: [
    { label: 'ID', key: '_id' },
    { label: 'Username', key: 'username' },
    { label: 'Email', key: 'email' },
    { label: 'Role', key: 'role' },
    { label: 'Agency', key: 'agency' },
    { label: 'Actions', key: 'actions', center: true, minWidth: 'min-w-[9rem]', canAction: !(perms.includes('users:update') || perms.includes('users:delete')) }
  ],
  rows: users.map(u => ({
    _id: u._id,
    username: u.username,
    email: u.email || '-',
    role: u.role ? u.role.name : '-',
    agency: u.agency ? u.agency.name : '-',
    actions: `
      ${(perms.includes('users:update')) ? 
        `<a href="/admin/users/${u._id}/edit" class="inline-block px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition duration-300">Sửa</a>` 
        : ''}

      ${(perms.includes('users:delete')) ? 
        `<form action="/admin/users/${u._id}/delete" method="POST" class="inline" onsubmit="return confirm('Xóa user này?');">
          <button class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition duration-300" type="submit">Xóa</button>
        </form>` 
        : ''}
    `
  }))
}) %>
